{% extends "core/base.html" %} {% block title %}Ingressos - {% endblock %} {%
block content %}
<div class="container py-4">
  <div class="row mb-4">
    <div class="col-md-8">
      <h1>
        <i class="fas fa-ticket-alt"></i> Ingressos - {{ vaquejada.nome }}
      </h1>
    </div>
    <div class="col-md-4 text-end">
      <a
        href="{% url 'exportar_excel' vaquejada.id %}"
        class="btn btn-success btn-sm"
      >
        <i class="fas fa-file-excel"></i> Excel
      </a>
      <a
        href="{% url 'exportar_csv' vaquejada.id %}"
        class="btn btn-info btn-sm"
      >
        <i class="fas fa-file-csv"></i> CSV
      </a>
      <a
        href="{% url 'admin_vaquejadas' %}"
        class="btn btn-outline-secondary btn-sm"
      >
        <i class="fas fa-arrow-left"></i> Voltar
      </a>
    </div>
  </div>

  {% if ingressos %}
  <div class="table-responsive">
    <table class="table table-hover table-bordered">
      <thead class="table-primary">
        <tr>
          <th>Representação</th>
          <th>Puxador</th>
          <th>Esteiro</th>
          <th>Categoria</th>
          <th>Status</th>
          <th>Comprovante</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody>
        {% for ingresso in ingressos %}
        <tr>
          <td><strong>{{ ingresso.representacao }}</strong></td>
          <td>{{ ingresso.puxador }}</td>
          <td>{{ ingresso.esteiro }}</td>
          <td>{{ ingresso.categoria.nome }}</td>
          <td>
            {% if ingresso.status == 'open' %}
            <span class="badge bg-warning">Aberto</span>
            {% elif ingresso.status == 'closed' %}
            <span class="badge bg-info">Aguardando</span>
            {% elif ingresso.status == 'paid' %}
            <span class="badge bg-success">Pago</span>
            {% else %}
            <span class="badge bg-secondary"
              >{{ ingresso.get_status_display }}</span
            >
            {% endif %}
          </td>
          <td>
            {% if ingresso.comprovante_pix %}
            <a
              href="{{ ingresso.comprovante_pix.url }}"
              class="btn btn-sm btn-info"
              target="_blank"
            >
              <i class="fas fa-file"></i> Ver
            </a>
            {% else %}
            <span class="text-muted small">—</span>
            {% endif %}
          </td>
          <td>
            {% if ingresso.status == 'closed' and ingresso.comprovante_pix %}
            <form
              method="post"
              action="{% url 'admin_confirmar_pagamento' ingresso.id %}"
              style="display: inline"
            >
              {% csrf_token %}
              <button
                type="submit"
                class="btn btn-sm btn-success"
                onclick="return confirm('Confirmar pagamento?');"
              >
                <i class="fas fa-check"></i> Confirmar
              </button>
            </form>
            {% elif ingresso.status == 'paid' %}
            <span class="text-success"
              ><i class="fas fa-check-circle"></i> Confirmado</span
            >
            {% else %}
            <span class="text-muted small">—</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info">
    <i class="fas fa-info-circle"></i> Nenhum ingresso encontrado.
  </div>
  {% endif %}

  <!-- Resumo -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card border-0 shadow">
        <div class="card-body">
          <h5>Resumo Financeiro</h5>
          {% for categoria in vaquejada.categorias.all %} {% with
          total_categoria=categoria.ingressos.count
          pago_categoria=categoria.ingressos.filter|dictsort:"status,closed" %}
          <p>
            <strong>{{ categoria.nome }}:</strong>
            {{ pago_categoria|length }} pagos de {{ total_categoria }} vendidos
            (R$ {{ categoria.valor|floatformat:2 }} cada)
          </p>
          {% endwith %} {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
